PROJECT (INTROLAB-ManyEars)

cmake_minimum_required(VERSION 2.6)

########################
# Configurations
########################
SET(CPACK_PACKAGE_VERSION_MAJOR "1")
SET(CPACK_PACKAGE_VERSION_MINOR "1")
SET(CPACK_PACKAGE_VERSION_PATCH "4-2")
SET(CPACK_PACKAGE_VERSION ${CPACK_PACKAGE_VERSION_MAJOR}.${CPACK_PACKAGE_VERSION_MINOR}.${CPACK_PACKAGE_VERSION_PATCH})


#OSX Architecture, will build for 32 bits systems
#set(CMAKE_OSX_ARCHITECTURES "i386")

#SET THE BUILD TYPE HERE, Release, Debug
SET(CMAKE_BUILD_TYPE Release)


#Additional modules
SET(CMAKE_MODULE_PATH ${PROJECT_SOURCE_DIR}/macros)

#Here we are assuming SSE3 support
#IF (CMAKE_COMPILER_IS_GNUCC OR CMAKE_COMPILER_IS_GNUCXX )
    MESSAGE( STATUS "Setting flags for GNU GCC")
    ADD_DEFINITIONS(-DUSE_SIMD)
    set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "-msse3 -Wall")
    set(CMAKE_CXX_FLAGS ${CMAKE_CXX_FLAGS} "-msse3 -Wall")
    SET(MANYEARS_LINK_FLAGS "-O3")
#ENDIF(CMAKE_COMPILER_IS_GNUCC OR CMAKE_COMPILER_IS_GNUCXX)

IF (MSVC)
	MESSAGE( STATUS "Setting flags for Visual Studio")
    ADD_DEFINITIONS(-DUSE_SIMD -D__SSE__ -D__SSE2__ -D_CRT_SECURE_NO_WARNINGS)
	SET(MANYEARS_LINK_FLAGS " ")
	set(CMAKE_C_FLAGS ${CMAKE_C_FLAGS} "/arch:SSE2") 
ENDIF(MSVC)


IF(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)
	IF(WIN32)
		MESSAGE( STATUS "Windows version: " ${CMAKE_SYSTEM})
			IF(MSVC)
				SET(CMAKE_INSTALL_PREFIX "$ENV{SYSTEMDRIVE}/ManyEars-win32-VS-${CPACK_PACKAGE_VERSION}")
			ELSE(MSVC)
				SET(CMAKE_INSTALL_PREFIX "$ENV{SYSTEMDRIVE}/ManyEars-win32-mingw-${CPACK_PACKAGE_VERSION}")
			ENDIF(MSVC)
		MESSAGE( STATUS "Install directory is : " ${CMAKE_INSTALL_PREFIX})
	ELSE(WIN32)
			SET(CMAKE_INSTALL_PREFIX "/usr/local/manyears")
	ENDIF(WIN32)
ENDIF(CMAKE_INSTALL_PREFIX_INITIALIZED_TO_DEFAULT)

# use, i.e. don't skip the full RPATH for the build tree
SET(CMAKE_SKIP_BUILD_RPATH  FALSE)

# when building, don't use the install RPATH already
# (but later on when installing)
SET(CMAKE_BUILD_WITH_INSTALL_RPATH FALSE)

# the RPATH to be used when installing
SET(CMAKE_INSTALL_RPATH "${CMAKE_INSTALL_PREFIX}/lib")

# add the automatically determined parts of the RPATH
# which point to directories outside the build tree to the install RPATH
SET(CMAKE_INSTALL_RPATH_USE_LINK_PATH TRUE)




#finding qt
IF (WIN32)
	 IF (NOT MSVC)
		SET(MANYEARS_LINK_FLAGS "--enable-auto-import")
     ENDIF(NOT MSVC)
	 SET (QT_USE_QTMAIN TRUE)
ENDIF (WIN32)



INCLUDE(InstallRequiredSystemLibraries)

#This will enable to output everything in the bin directory for testing and debugging...
SET (EXECUTABLE_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/bin)
SET (LIBRARY_OUTPUT_PATH ${PROJECT_SOURCE_DIR}/bin)

# the next line sets up include and link directories and defines some variables that we will use.
# you can modify the behavior by setting some variables, e.g.
#   
# -> this will cause cmake to include and link against the OpenGL module

IF (NOT MANYEARS_GUI_DISABLED)

    SET(QT_USE_QTNETWORK TRUE)
    SET(QT_USE_QTSVG TRUE)
    SET(QT_USE_QTXML TRUE)
    SET(QT_USE_QTSCRIPT TRUE)
    SET(QT_USE_QTOPENGL TRUE)
    SET(QT_USE_QTMULTIMEDIA TRUE)

    find_package(QtMobility COMPONENTS MultimediaKit)
    find_package(Qt4 4.8.0 QUIET)
    
    if (QTMOBILITY_FOUND)
        MESSAGE("QT_MOBILITY_INCLUDE_DIR : ${QTMOBILITY_INCLUDE_DIRS} QT_MOBILITY_LIB: ${QTMOBILITY_LIBRARIES}")
    ENDIF (QTMOBILITY_FOUND)
    
    
    if(QT4_FOUND AND (QT_QTMULTIMEDIA_FOUND OR QTMOBILITY_FOUND))
	include(${QT_USE_FILE})
    else(QT4_FOUND AND (QT_QTMULTIMEDIA_FOUND OR QTMOBILITY_FOUND))
        MESSAGE("WARNING : ManyEars GUI will not be compiled because Qt4 not found or obsolete. You need Qt 4.8 or higher.Try using the latest QtSDK from http://qt-project.org")
        MESSAGE("DEBUG: QT4_FOUND: ${QT4_FOUND} QT_MULTIMEDIA_FOUND: ${QT_QTMULTIMEDIA_FOUND}  QT_MOBILITY_FOUND: ${QTMOBILITY_FOUND}")
        SET(MANYEARS_GUI_DISABLED TRUE)
    endif(QT4_FOUND AND (QT_QTMULTIMEDIA_FOUND OR QTMOBILITY_FOUND))

ELSE (NOT MANYEARS_GUI_DISABLED)
    MESSAGE("ManyEars GUI disabled.")
ENDIF (NOT MANYEARS_GUI_DISABLED)


#Files excluded from package
set(CPACK_SOURCE_IGNORE_FILES
  "build"
  "bin"
  ${CPACK_SOURCE_IGNORE_FILES}
  ".svn"
)



#include files
IF (WIN32)

    #EXECUTE QT_QMAKE TO FIND ALL NECESSARY LIBRARY WE NEED TO INSTALL
    EXEC_PROGRAM(${QT_QMAKE_EXECUTABLE} ARGS "-query QT_INSTALL_BINS" OUTPUT_VARIABLE QTBINS)
    SET(QT_BINARY_DIR ${QTBINS} CACHE INTERNAL "" FORCE)
    FILE(GLOB QT_DLL "${QT_BINARY_DIR}/*.dll")
    FILE(GLOB QT_DEBUG_DLL "${QT_BINARY_DIR}/*d4.dll")
    list(REMOVE_ITEM QT_DLL ${QT_DEBUG_DLL})


    #WE NEED TO CORRECT THE PATH OF EACH REMAINING LIBRARY SINCE "\" IS CONSIDER AN ESCAPE SEQUENCE FOR CMAKE
    FOREACH(LIB ${QT_DLL})
        STRING(REGEX REPLACE "\\\\" "/" NEWLIB ${LIB})
        list(REMOVE_ITEM QT_DLL ${LIB})
        list(APPEND QT_DLL ${NEWLIB})
    ENDFOREACH(LIB)

    INSTALL(FILES ${QT_DLL} DESTINATION bin)

    #############################
    # Packaging stuff for Windows
    #############################
    SET(CPACK_SOURCE_GENERATOR "ZIP")
    SET(CPACK_RESOURCE_FILE_LICENSE "${PROJECT_SOURCE_DIR}/COPYING.TXT")
    SET(CPACK_PACKAGE_NAME "ManyEars")
    SET(CPACK_PACKAGE_DESCRIPTION_SUMMARY "ManyEars")
    SET(CPACK_PACKAGE_VENDOR "IntRoLab")
    SET(CPACK_PACKAGE_DESCRIPTION_FILE "${PROJECT_SOURCE_DIR}/README.TXT")
    SET(CPACK_PACKAGE_CONTACT "francois.grondin@usherbrooke.ca")
    SET(CPACK_PACKAGE_INSTALL_DIRECTORY "ManyEars")
    SET(CPACK_NSIS_URL_INFO_ABOUT "http://introlab.gel.usherbrooke.ca")
    SET(CPACK_NSIS_CONTACT "dominic.letourneau@usherbrooke.ca")
    SET(CPACK_NSIS_MODIFY_PATH OFF)
    SET(CPACK_PACKAGE_EXECUTABLES "ManyEars" "ManyEars")

    INSTALL(FILES ${PROJECT_SOURCE_DIR}/README.TXT DESTINATION .)

   
ENDIF (WIN32)

IF (UNIX)

	    #########################################
	    # Packaging stuff for sources (All UNIX)
	    #########################################
	    SET(CPACK_SOURCE_GENERATOR "TGZ")
            SET(CPACK_RESOURCE_FILE_LICENSE "${PROJECT_SOURCE_DIR}/COPYING.TXT")
	    SET(CPACK_PACKAGE_NAME "ManyEars")
	    SET(CPACK_PACKAGE_DESCRIPTION_SUMMARY "ManyEars")
	    SET(CPACK_PACKAGE_VENDOR "Francois Grondin, Dominic Letourneau")
            SET(CPACK_PACKAGE_DESCRIPTION_FILE "${PROJECT_SOURCE_DIR}/README.TXT")
	    SET(CPACK_PACKAGE_CONTACT "francois.grondin@usherbrooke.ca")


	IF(APPLE)
	
            ##########################
	    # Packaging stuff for OSX
	    ##########################
            SET(CPACK_RESOURCE_FILE_LICENSE "${PROJECT_SOURCE_DIR}/COPYING.TXT")
            SET(CPACK_GENERATOR DragNDrop)

            #SET(CPACK_PACKAGE_INSTALL_DIRECTORY "/Applications")
            #SET(MACOSX_BUNDLE_INFO_STRING "ManyEars")
            #SET(CPACK_PACKAGE_FILE_NAME "ManyEars-${CPACK_PACKAGE_VERSION}")
            #SET(CPACK_BUNDLE_NAME "ManyEars")
            #SET(CPACK_PACKAGE_DEFAULT_LOCATION "/Applications")
            #SET(CPACK_BUNDLE_PLIST "ManyEars.plist")
            #SET(CPACK_BUNDLE_ICON "ManyEars.icns")
            #SET(CPACK_PACKAGE_ICON "ManyEars.icns")
            #SET(CPACK_BUNDLE_STARTUP_COMMAND "startup.sh")

            #BUNDLE INFO
            SET(MACOSX_BUNDLE_INFO_STRING "ManyEars")
            SET(MACOSX_BUNDLE_ICON_FILE "ManyEars.icns")
            SET(MACOSX_BUNDLE_GUI_IDENTIFIER "ManyEars")
            SET(MACOSX_BUNDLE_LONG_VERSION_STRING "ManyEars-${CPACK_PACKAGE_VERSION}")
            SET(MACOSX_BUNDLE_BUNDLE_NAME "ManyEars.app")
            SET(MACOSX_BUNDLE_SHORT_VERSION_STRING "${CPACK_PACKAGE_VERSION}")
            SET(MACOSX_BUNDLE_BUNDLE_VERSION "${CPACK_PACKAGE_VERSION}")
            SET(MACOSX_BUNDLE_COPYRIGHT "README.TXT")            
            SET(MACOSX_BUNDLE_INFO_PLIST "Info.plist")

	    INSTALL(FILES ${PROJECT_SOURCE_DIR}/README.TXT DESTINATION .)

        ELSE(APPLE)
            ##########################
		    # Packaging stuff for Linux
		    ##########################
		    SET(CPACK_GENERATOR DEB)
		    SET(CPACK_DEBIAN_PACKAGE_NAME "Manyears")
		    SET(CPACK_DEBIAN_PACKAGE_VERSION ${CPACK_PACKAGE_VERSION})
		    SET(CPACK_DEBIAN_ARCHITECTURE i686)
		    SET(CPACK_DEBIAN_PACKAGE_DEPENDS "")
		    SET(CPACK_DEBIAN_PACKAGE_MAINTAINER "dominic.letourneau@usherbrooke.ca")
		    SET(CPACK_DEBIAN_PACKAGE_DESCRIPTION "Manyears Software package.")
		    SET(CPACK_DEBIAN_PACKAGE_SECTION "devel")
		    SET(CPACK_DEBIAN_PACKAGE_PRIORITY "optional")
		    SET(CPACK_DEBIAN_PACKAGE_RECOMMENDS "")
		    SET(CPACK_DEBIAN_PACKAGE_SUGGESTS "")
	
	ENDIF(APPLE)
ENDIF(UNIX)

##########################
# Definitions
##########################
ADD_DEFINITIONS(-DDEF_PACKAGE_NAME="${CPACK_PACKAGE_NAME}")
ADD_DEFINITIONS(-DDEF_PACKAGE_VERSION="${CPACK_PACKAGE_VERSION}")
ADD_DEFINITIONS(-DDEF_PACKAGE_VENDOR="${CPACK_PACKAGE_VENDOR}")
ADD_DEFINITIONS(-DDEF_NSIS_URL_INFO_ABOUT="${CPACK_NSIS_URL_INFO_ABOUT}")
ADD_DEFINITIONS(-DDEF_RESOURCE_FILE_LICENSE="${CPACK_RESOURCE_FILE_LICENSE}")
ADD_DEFINITIONS(-DDEF_PACKAGE_DESCRIPTION_FILE="${CPACK_PACKAGE_DESCRIPTION_FILE}")
ADD_DEFINITIONS(-DDEF_PROJECT_SOURCE_DIR="${PROJECT_SOURCE_DIR}")

ADD_SUBDIRECTORY(dsplib)
ADD_SUBDIRECTORY(RTAudio)
ADD_SUBDIRECTORY(example)
ADD_SUBDIRECTORY(demo)
IF(NOT MANYEARS_GUI_DISABLED)
	ADD_SUBDIRECTORY(QtGUI)
ENDIF(NOT MANYEARS_GUI_DISABLED)

add_custom_target(dist COMMAND ${CMAKE_MAKE_PROGRAM} package_source)




INCLUDE(CPack)
